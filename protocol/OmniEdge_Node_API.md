# 1. OmniEdge_Node_API

- Authors: Bright
- Status: **Draft** | Discussion | Development | Active | Dropped | Superseded

**ChangeLog**
| Version | Developer |Time|Remark |
|--- | --- | --- | --- |
|Draft| Bright | Jan.15th,2020 |


# 2. API Summary
Here the API definition is divided into two categories.

- Node (including Super Node) and back-end communication, using **RestAPI + Https**
- Communication between Nodes, to improve data parsing and forwarding efficiency, use **Data Structure + Encryption + UDP**
  
## 2.1. RESTAPI  List

|  API | URI | Parameters | Remarks | Priority|
| --- | --- |  --- |  --- | --- |
|  register node device | /node/register |  |  | 1 |
|  register super node device | /snode/register |  |  | 2 |
|  Get node network | /node/{node_id}/network | Correspondig fingerprint node(id) to the network information| |  1 |
|  Get supernode network | /snode/{snode_id}/network | Corresponding to the supernode network information | | 2 |
|  Node get p2p network information | /node/{node_id}/p2p/{network_id}/network | P2P information to the networkf information {ID} | | 1 |
|  Super Get P2P Network Information | /snode/{snode_id}/p2p/{network_id}/network | P2P information of the corresponding network{ID} | | 1 |
|  Uploading node statistics| /node/{node_id}/statistic | Traffic statistics, etc |   | 3 |
|  Uploading supernode statistics | /snode/{node_id}/statistic | Traffic statistics, etc |   | 3 |
|  Uploading supernode network statistics| /snode/{snode_id}/network/{network_id}/statistic | Traffic statistics, etc |   | 3 |    
| Send supernode command | /snode/{id}/command | supernodeID |  | 4|
| Send node command | /node/{id}/command | NodeID  |  | 4 |

### 2.2. Error code description
### 2.2.1. Error code enumeration
| situation | code | message | description | solution |
| --- | ---| --- | --- | --- |
| command success | 200 | success | - |
| command success | 201 | success, unauthorized | unauthenticated device | - |
| device is repeatedly registered, failed | 401 | does not exist | - |
| blacklist, failed | 402 | certificate revoked | reset device or delete public and private keys, rejoin |

***TODO， need add more***
### 2.2.2. Device duplicate registration
- Public key
- Hardware computed UUID (hardware UUID computation, with backend for processing to avoid being hacked)
- Network ID


## 3. RestAPI description
## 3.1. Registering Node
**Backend related interface**, this interface can register a device to different networks according to different users, here the user ID is not used, but the network id obtained after the user created the network is used instead.
### 3.1.1. URI
- **Post** /node/register

Parameter description (** parameters are only supported on specific platforms**, the corresponding parameters do not exist for unsupported platforms).
### 3.1.2. Input parameters
The parameters contain three major categories.
- Hardware UUID
- Network
- Secret key

**Hardware UUID** Related parameters ：

| Parameters | Description                        | mac | win/linux | openwrt | nas | android | ios |
| --- | ---                         | :---: | :---: | :---: |  :---: | :---: |:---: |
| os      | OS Type          | Y | Y |Y |Y | Y | Y |
| verison | Version             | Y | Y |Y |Y | Y | Y |
| hostname | Hostname             | Y | Y |Y |Y | Y | Y |
| cpu     | cpu type        | Y | Y | Y | - | - | - |
| disk    | disk S/N       | -  | Y | - | -  | - | - |
| nic     | Network card macID list | Y | Y | Y | Y | - | - |
| oaid    | CN OAID         |  - |  - | - | - | Y | - |
| adid    | Goole ID        | Y | Y | - | - | - | Y |
| wlan    | Wifi macID      | Y | Y | - | - | - | - | - |
| idfa    | IOS ID1         | - | - | - | - |- | Y|
| idfv    | IOS ID2         | - | - | - | - | - | Y |
| uuid    | UUID generated by client | Y | Y |Y |Y | Y | Y |


**Network** Related，Using this parameter will attempt to add the device to the specified network
| Paramters | Description                        | mac | win/linux | openwrt | nas | android | ios |
| --- | ---                         | :---: | :---: | :---: |  :---: | :---: |:---: |
| network_id      | NetworkID               | Y | Y |Y |Y | Y | Y |
| alias      | Device Alias for dashboard| Y | Y |Y |Y | Y | Y |

**Secret Key** Related
When encountering revocation of permission on the web side, the secret key will be regenerated and re-registered

| Paramters | Description                            | mac | win/linux | openwrt | nas | android | ios |
| --- | ---                         | :---: | :---: | :---: |  :---: | :---: |:---: |
| rsa      | Public Key         | Y | Y |Y |Y | Y | Y |

**Other**Related
| Paramters | Description             | mac | win/linux | openwrt | nas | android | ios |
| --- | ---                         | :---: | :---: | :---: |  :---: | :---: |:---: |
| sw_version      | Public Key         | Y | Y |Y |Y | Y | Y |

### 3.1.3. Output parameters
| Parameters | Type            | Description |
| --- | ---             | --- |
| code      | int32_t   | Returns the status code         | 
| msg       | string    | Error information         |
| uuid        | uint64_t  |fingerprint information assigned by the device, here simply use large integers, for node fast identification has advantages, it is recommended that the server side can be a database index configuration other mechanisms to generate UUID | 
### 3.1.4. Example
#### 3.1.4.1. input
An example with the Windows parameter
```json
{
    os ：“Windows”，
    version：“6.5”，
    hostname ：“wang-win-16.04”，
    cpu：“cpu1|cpu2”，
    disk：“disk1|disk2”,
    nic：“mac1|mac2”，
    alias ：“Omni-Aws-01”,
    sw_version：“0.1.0-beta”，
    uuid : "01FEFESQSWEQWEQW"
    ras :"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCs60i09byvd0DboJMsrLOYIg1r7FQhR9mmo43SGV5AHwha6wlvmZfGlBCNq6O96INwNud6JN+P0cbf4+rMjdh/pQ+d+xNTcostq8dgdd7CLJg4tjWt8Pzu+x7iqMwQZtVDeFGUv5JK1Ro8np505qfhd/jNGlW2TrfVP9095uYmig1kEQ19EWELfutROe/zPPQKwGhiPiYnd+T91h3t8BfsSJFbnLBO7S37yjsb/g7yqEAEWtNXjShTGvCQenYQjViPjm9SOVUIScPuNmImRrIzcV1VIAgq8rrFgKNg/T2Za8niGGprABCBmVeEi4xXtnrcVg8vaANoF9opMx+W7ulf Dandan@DESKTOP-FNSU7A9"
}
```
#### 3.1.4.2. output
```json
{
    code: ,
    msg: "Device is added Successfully"，
    uuid : 125687
}
```


## 3.2. Registering Super Node
**Backend related interface**, this interface can register a device to different networks according to different users, instead of using the user id, the network id obtained after the user created the network is used here instead.
### 3.2.1. URI
- **Post**   /snode/register

### 3.2.2. Register Super Node

### 3.2.3. Input Parameters
Hardware UUID Related parameters：

| Parameters  | Description                        | win | linux | openwrt  |
| --- | ---                         | :---: | :---: | :---: |
| os      | OS type          | Y | Y | Y |
| verison | Version             | Y | Y | Y |
| hostname | Hostname             | Y | Y | Y |
| ip |  IP Address | Y | Y | Y |
| port |  Port  | Y | Y | Y |

**Network** related, using this parameter will try to add the device to the specified network
| Parameters  | Description                     | mac | win/linux | openwrt | nas | android | ios |
| --- | ---                         | :---: | :---: | :---: |  :---: | :---: |:---: |
| alias  | Deivce alias | Y | Y |Y |Y | Y | Y |

**Secret Key** Related
When encountering revocation of permission on the web side, the secret key will be regenerated and re-registered

| Parameters  | Description                       | mac | win/linux | openwrt | nas | android | ios |
| --- | ---                         | :---: | :---: | :---: |  :---: | :---: |:---: |
| rsa      | Public Key         | Y | Y |Y |Y | Y | Y |

**Other** Related
| Parameters  | Description                       | mac | win/linux | openwrt | nas | android | ios |
| --- | ---                         | :---: | :---: | :---: |  :---: | :---: |:---: |
| sw_version      | Public key         | Y | Y |Y |Y | Y | Y |

### 3.2.4. Output parameters
| Parameters | Type | Description |
| --- | --- | --- |
| code | int32_t | Returns the status code | 
| msg | string | error message |
| uuid | uint64_t | fingerprint information assigned by the device, here simply use large integers, for node fast identification has advantages, it is recommended that the server side can be a database index configuration other mechanisms to generate UUID | 


**NOTE** Conditions for duplicate registration of devices.
- Public key
- Hardware calculated UUID (hardware UUID calculation with backend for processing to avoid being hacked)
- Network ID


### 3.2.5. Example
#### 3.2.5.1. input
An example with the CentOS parameter
```json
{
    os ：“Centos”，
    version：“6.5”，
    hostname ：“centos-16.04”，    
    ip ：“88.88.88.88”，
    port：“1024”，
    version：“5.0”，
    sw_version：“0.1.0-beta”，
    alias：“aws_east_us”
}
```
#### 3.2.5.2. output
```json
{
    code: ,
    msg: "Device is added Successfully"，
    uuid : 125687
}
```


Return Results：
| Parameters  | Description                       | win | linux | openwrt  |
| --- | ---                         | :---: | :---: | :---: |
| code      | error code          | Y | Y | Y |
| message      | message          | Y | Y | Y |
| device_id      | Device fingerprint, here simply use large integers, for node fast identification has the advantage of suggesting that the server side can be a database index configuration other mechanisms      | Y | Y | Y |


## 3.3. Get node network information
**Backend related interface**
Get the required network network related information of the node
## 3.3.1. Base path
- **GET** /node/{id}/network
### 3.3.2. Input parameters
| parameters | type | description |
| --- | --- | --- |
| id | int32_t | Node node encoding |
### 3.3.3. Output parameters
| parameters | type | description |
| --- | --- | --- |
| code | int32_t | Returns the status code |
| msg | string | |
| ip | string | IP information |
| netmask | string | network mask |
| gateway | string | gateway information |
| route | string | Return status code |


### 3.3.4. Example
#### 3.3.4.1. input
None

#### 3.3.4.2. output
```json
{
    code: 200,
    msg: "success"，
    ip : “10.10.10.110”，
    netmask：“255.255.255.0”，
    gateway：“10.10.10.1”，
    route： [
                {
                    network: "0.0.0.0" ,
                    mask: "0.0.0.0",
                    gateway: "10.10.10.1",
                    metric: "1"
                },
                {
                    network: "192.168.1.0" ,
                    mask: "255.255.255.0",
                    gateway: "192.168.0.1",
                    metric: "1"
                }
           ]
}
```

## 3.4. Get super node network information
**Backend related interface** to get the information related to the network network required by the node
## 3.4.1. Base path
- **GET** /snode/{id}/network
### 3.4.2. Input parameters
| parameter | type | description |
| --- | --- | --- |
| id | int32_t | Super Node node encoding |
### 3.4.3. Output parameters
| parameters | type | description |
| --- | --- | --- |
| code | int32_t | Returns the status code |
| msg | string | |
| ip | string | IP information |
| port | string | port information |

### 3.4.4. Example
#### 3.4.4.1. input
None

#### 3.4.4.2. output
```json
{
    code: 200,
    msg: "success"，
    ip : “10.10.10.110”，
    port：“88.88.88.88”，
    ras :" rsa Public Key"
}
```



## 3.5. Super Node Network Statistics
**Backend related interface**, statistics of SuperNode
## 3.5.1. URI
- **Post** /snode/{super_node_id}/{network_id}/statistic
### 3.5.2. URL parameters
| parameters | type | description |
| --- | --- | --- |
| super_node_id | uint64_t | SuperNode node ID |
| network_id | uint64_t | network_id |

### 3.5.3. Input Parameters
| parameters | type | description |
| --- | --- | --- |
| active_node | uint64_t | SuperNode node ID |
| route_flow | uint64_t | |
**NOTE** Add more later as needed


### 3.5.4. Output parameters
The P2P network parameters consist of two parts.
- Super Node information
- Node penetration information
  
| Parameters | Type | Description |
| --- | --- | --- |
| code | int32_t | Return status code |
| msg | string | |


### 3.5.5. Example
#### 3.5.5.1. input
None

#### 3.5.5.2. output
```json
{
    code: 200,
    msg: "success"，
    snode： [
                {
                    uuid ：100，
                    ip : “10.10.10.110”，
                    port：“5000”,
                    rsa :"RSA Publich Key"
                }
            ],
    node:   [
                {
                    uuid ：123455，
                    rsa :" RSA Publich Key"，
                    ip : “10.100.10.110”，
                    port：“11223”                    
                }，
                {
                    uuid ：123456，
                    rsa :" RSA Publich Key"，
                    ip : “10.165.10.111”，
                    port：“11225”                    
                }
            ]
}
}
```



## 3.6. Node statistics reporting
**Backend related interface**, statistics of SuperNode
## 3.6.1. URI
- **Post** /node/{id}/statistic
### 3.6.2. Input parameters
| parameters | type | description |
| --- | --- | --- |
| id | int64_t | node fingerprint information |

### 3.6.3. Output parameters
The P2P network parameters consist of two parts.
- Super Node information
- Node node penetration information
  

| parameters | type | description |
| --- | --- | --- |
| code | int32_t | Return status code |
| msg | string | |


**Super Node** Related
| parameters | type | description |
| --- | --- | --- |
| uuid | uint64_t | node fingerprint |
| ip | string | public IP information |
| port | string | port information |
| rsa | string | public key information |

**Node** related
| parameters | type | description |
| --- | --- | --- |
| uuid | uint64_t | Node fingerprint |
| ip | string | Export IP information |
| port | string | port information |
| rsa | string | public key information |

***NOTE*** Some penetration information will be added later based on N2N

### 3.6.4. Example
#### 3.6.4.1. input
None

#### 3.6.4.2. output
```json
{
    code: 200,
    msg: "success"，
    snode： [
                {
                    uuid ：100，
                    ip : “10.10.10.110”，
                    port：“5000”,
                    rsa :"RSA Publich Key"
                }
            ],
    node:   [
                {
                    uuid ：123455，
                    rsa :" RSA Publich Key"，
                    ip : “10.100.10.110”，
                    port：“11223”                    
                }，
                {
                    uuid ：123456，
                    rsa :" RSA Publich Key"，
                    ip : “10.165.10.111”，
                    port：“11225”                    
                }
            ]
}
}
```






## 3.7. Super Node statistics reporting
**Backend related interface**, statistics of SuperNode
## 3.7.1. Base path
- **Post** /snode/{network_id}/statistic
### 3.7.2. Input parameters
| Parameters | Type | Description |
| --- | --- | --- |
| network_id | int32_t | network_id_code |

### 3.7.3. Output parameters
The P2P network parameters consist of two parts.
- Super Node information
- Node node penetration information
  

| parameters | type | description |
| --- | --- | --- |
| code | int32_t | Return status code |
| msg | string | |


**Super Node** Related
| parameters | type | description |
| --- | --- | --- |
| uuid | uint64_t | node fingerprint |
| ip | string | public IP information |
| port | string | port information |
| rsa | string | public key information |

**Node** related
| parameters | type | description |
| --- | --- | --- |
| uuid | uint64_t | Node fingerprint |
| ip | string | Export IP information |
| port | string | port information |
| rsa | string | public key information |

***NOTE*** Some penetration information will be added later based on N2N

### 3.7.4. Example
#### 3.7.4.1. input
None

#### 3.7.4.2. output
```json
{
    code: 200,
    msg: "success"，
    snode： [
                {
                    uuid ：100，
                    ip : “10.10.10.110”，
                    port：“5000”,
                    rsa :"RSA Publich Key"
                }
            ],
    node:   [
                {
                    uuid ：123455，
                    rsa :" RSA Publich Key"，
                    ip : “10.100.10.110”，
                    port：“11223”                    
                }，
                {
                    uuid ：123456，
                    rsa :" RSA Publich Key"，
                    ip : “10.165.10.111”，
                    port：“11225”                    
                }
            ]
}
}
```



# 4. inter-Node API list
Each packet consists of header+payload
## 4.1 header data structure

The data structure uses Big-Endian to be compatible with different platforms, and the header should not be too large, considering that each packet should be limited to MTU, so moderate size is necessary.

**Data content:**
| Parameter | Type | Description | Remarks |
| --- | --- | --- | --- |
| des_uuid | uint64_t | target_fingerprint |
| src_uuid | uint64_t | originator fingerprint |
| cmd_id | uint16_t | command_definition |
| token | char[8] | | Server-assigned communication token, simple checksum between user nodes, set valid time |
| timestamp | uint32_t | Current timestamp | Timestamp affects header hash generation to prevent forgery |
| payload_size | uint16_t | payload encrypted data size | | payload_crc | uint16_t
| payload_crc | uint16_t | payload encrypted data crc | |
| payload_plain_size | uint16_t | payload original_data_size | |
| payload_plain_crc | uint16_t | payload raw_data_crc | |
| header_plain_crc | uint16_t | payload raw data crc | |
| ------ | ----- | ----- |
| header_crc | uint16_t | header header encrypted data calculated by CRC | |

**NOTE:** Here use crc32 or crc16, and then or more simplified heterogeneous checksum, the hash value of all the content encrypted before the hash, the receiver confirms whether the data header is valid by comparing the hash, here use more than medium strength encryption to avoid being cracked, or even completely use public and private keys not called encryption, but it depends on the actual performance

### 4.11 header encryption operation flow

```mermaid
sequenceDiagram
    participant N as Node
    participant S as Super Node/Node
    loop Communication flow
        N --> N : fill payload, calculate plain and encrypted data and corresponding crc
        N --> N : fill header corresponding field, select cmd field, calculate Header plain crc
        N -->> N : encrypt and calculate fill header crc
        N ->> S : send header+payload
        S ->>> S : check header crc
        S ->>> S : decrypt header and verify
        S ->>> S : decrypt the payload
        S ->>> S : Process the payload
        S -->> S : Ensure package-fill payload, calculate plain and encrypted data and corresponding crc
        S -->> S : Secure package-populate header corresponding field, select cmd field, calculate Header plain crc
        S -->> S : encrypt and calculate header crc
        S -->> N : Ensure packet-padding header hash and send
        N ->>> N : check header crc
        N -->> N : decrypt header and check
        N -->> N : Decrypt the payload
        N -->> N : Process the payload
    end

```

**NOTE** Symmetric encryption algorithms are approximately 1500 times faster than asymmetric encryption algorithms
**Examples of data structures:**
```c
struct{
    uint64_t des_uuid,
    uint64_t src_uuid,
    uint32_t cmd_id,
    char[8]  token,
    uint32_t timestamp,
    uint16_t payload_size,
    uint16_t payload_crc,
    char[8] header_hash
}
```

### 4.12 header cmd definition
The command is a 16-bit unsigned integer, the initiating packet will be defined, the acknowledgement packet will be the highest position 1 by default, and the payload will be discarded and returned. Except for special packets.
| command | description | description | comments |
| --- | --- | --- | --- |
| 0x1 | Initiate symmetric secret key negotiation | Initiator selects symmetric secret key and algorithm |
| 0x8001 | Symmetric secret key confirmation | The reverse-order secret key returns the symmetric secret key using the symmetric secret key encryption.
| 0x2 | Normal packet sending | |
| 0x8002 | Normal packet acknowledgement | |
| 0x30 | Command packet | Reserved here
| 0x8030 | Command packet acknowledgement | |



## 4.2 payload data structure
### payload data structure

### cmd corresponding payload definition
